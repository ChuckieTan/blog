---
date: 2022/03/04 11:30
updated: 2022/03/04 11:30
tags: 
- 数据库
---

封锁是一项用于多用户同时访问数据库的技术，是实现并发控制的一项重要手段，能够防止当多用户改写数据库时造成数据不一致与冲突。当有一个用户对数据库内的数据进行操作时，在读取数据前先锁住数据，这样其他用户就无法访问和修改该数据，直到这一数据修改并写回数据库解除封锁为止。

## 封锁粒度

MySQL 中提供了两种封锁粒度：行级锁以及表级锁。

应该尽量只锁定需要修改的那部分数据，而不是所有的资源。锁定的数据量越少，发生锁争用的可能就越小，系统的并发程度就越高。

但是加锁需要消耗资源，锁的各种操作（包括获取锁、释放锁、以及检查锁状态）都会增加系统开销。因此封锁粒度越小，系统开销就越大。

在选择封锁粒度时，需要在锁开销和并发程度之间做一个权衡。

## 封锁类型

### 1、读写锁

数据库按照读写类型可以分为共享锁和排他锁，又称读锁和写锁。

排它锁（Exclusive），简写为 X 锁，又称写锁。若一个事务对数据对象 A 加了 X 锁，就可以对 A 进行读取和更新。加锁期间其它事务不能对 A 加任何锁。

共享锁（Shared），简写为 S 锁，又称读锁。若一个事务对数据对象 A 加了 S 锁，可以对 A 进行读取操作，但是不能进行更新操作。加锁期间其它事务能对 A 加 S 锁，但是不能加 X 锁。

锁的兼容关系如下：

|             | X 锁（写锁） | S 锁（读锁） |
| ----------- | ----------- | ----------- |
| X 锁（写锁） | 不兼容      | 不兼容      |
| S 锁（读锁） | 不兼容      | 兼容        | 

可以看到，只有读锁和读锁之间是相互兼容的，写锁和其他锁都不相互兼容。这也是符合逻辑的，因为读不会改变数据，所以一个数据可以被多个事务同时读，写会改变数据，所以在写的时候如果其他事务进行读写，就会发生错误。

### 2、意向锁

InnoDB 支持多粒度锁（multiple granularity locking），它允许行级锁与表级锁共存，而意向锁就是其中的一种表锁。

意向锁是一种不与其他行级锁冲突的表级锁，分为两种：

- 